extends: [setuptools_package]

dependencies:
  build: [blas, lapack, numpy, pybind11, pybind11_cmake]
  run: [blas, lapack, numpy, pybind11, pybind11_cmake]

sources:
 - key: tar.gz:33q3x45gzd3tw2zbrszi53mn2ezup2rp
   url: https://files.pythonhosted.org/packages/04/ab/e2eb3e3f90b9363040a3d885ccc5c79fe20c5b8a3caa8fe3bf47ff653260/scipy-1.4.1.tar.gz

build_stages:
- name: create-site.cfg
  after: prologue
  before: install
  handler: bash
  bash: |
    cat > site.cfg << EOF
    [ALL]
    extra_link_args = -shared
    [openblas]
    libraries = openblas
    library_dirs = ${OPENBLAS_DIR}/lib
    include_dirs = ${OPENBLAS_DIR}/include
    runtime_library_dirs = ${OPENBLAS_DIR}/include
    EOF

- name: set-LDFLAGS
  after: prologue
  before: install
  handler: bash
  bash: |
    export NPY_DISTUTILS_APPEND_FLAGS=1
    export CPPFLAGS="${CPPFLAGS} -I$(${PYTHON} -c "import numpy; print(numpy.get_include())") -I${PYBIND11_CMAKE_DIR}/include"
    echo $CPPFLAGS
    export LDFLAGS="-shared -Wl,-rpath=${PYTHON_DIR}/lib -Wl,-rpath=${OPENBLAS_DIR}/lib $(${PYTHON_DIR}/bin/python3-config --ldflags)"
    export LAPACK=None
    export BLAS=None
