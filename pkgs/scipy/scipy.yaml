extends: [setuptools_package]

dependencies:
  build: [blas, lapack, numpy, pybind11, pybind11_cmake, cython, ninja, pythran, meson, gast, beniget, ply, {{build_with}}]
  run: [blas, lapack, numpy, pybind11, pybind11_cmake, cython, ninja, pythran, meson, gast, beniget, ply]

sources:
- key: tar.xz:afan2jgrjtqzj7nt35ewyimq6cewzkck
  url: https://github.com/scipy/scipy/releases/download/v1.8.1/scipy-1.8.1.tar.xz

build_stages:
- name: create-site.cfg
  after: prologue
  before: install
  handler: bash
  bash: |
    cat > site.cfg << EOF
    [ALL]
    extra_link_args = -shared
    [openblas]
    libraries = openblas
    library_dirs = ${OPENBLAS_DIR}/lib
    include_dirs = ${OPENBLAS_DIR}/include
    runtime_library_dirs = ${OPENBLAS_DIR}/lib
    EOF
- name: set-LDFLAGS
  after: prologue
  before: install
  handler: bash
  bash: |
    export NPY_DISTUTILS_APPEND_FLAGS=1
    export CPPFLAGS="${CPPFLAGS} -I$(${PYTHON} -c "import numpy; print(numpy.get_include())") -I${PYBIND11_CMAKE_DIR}/include"
    echo $CPPFLAGS
    export LDFLAGS="-shared -Wl,-rpath=${PYTHON_DIR}/lib -Wl,-rpath=${OPENBLAS_DIR}/lib $(${PYTHON_DIR}/bin/python3-config --ldflags)"
    export LAPACK=None
    export BLAS=None
- name: install
  after: setup_dirs
  mode: replace
  handler: bash
  bash: |
    PATH=$MESON_DIR/bin:$CYTHON_DIR/bin:$PYTHRAN_DIR/bin:$PATH PYTHONPATH=$PYTHONPATH:$SETUPTOOLS_DIR/lib/python{{pyver}}/site-packages ${PYTHON} -c 'import setuptools; __file__="setup.py"; exec(open(__file__).read())' \
       ${SETUPTOOLS_PACKAGE_EXTRA_OPTIONS} \
       install \
       --prefix=. --root=${ARTIFACT} \
       --single-version-externally-managed
