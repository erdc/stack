extends: [autotools_package]
dependencies:
  build: [libxml2, pkg-config]

build_stages:
  - name: unset_extra_fortran
    after: prologue
    before: configure
    mode: replace
    handler: bash
    bash: |
      unset F77
      unset F90

  - name: configure
    mode: update
    extra: ['--enable-shared', '--with-device=ch4:ofi']

  - when: not fortran
    name: configure
    mode: update
    extra: ['--disable-f77', '--disable-fc', '--disable-fortran']

sources:
- key: tar.gz:ljbpdkej2srntfwcnzemx6ofsxf7imlm
  url: http://www.mpich.org/static/downloads/4.0.2/mpich-4.0.2.tar.gz

defaults:
  # bin/mpicc contains hard-coded path
  relocatable: false

when_build_dependency:
  - {set: 'MPICC', value: "${ARTIFACT}/bin/mpicc"}
  - {set: 'MPICXX', value: "${ARTIFACT}/bin/mpic++"}
  - {set: 'MPIF77', value: "${ARTIFACT}/bin/mpif77"}
  - {set: 'MPIF90', value: "${ARTIFACT}/bin/mpif90"}
  - {set: 'MPIEXEC', value: "${ARTIFACT}/bin/mpiexec"}

  - prepend_path: PATH
    value: ${ARTIFACT}/bin
  - prepend_path: PKG_CONFIG_PATH
    value: ${ARTIFACT}/lib/pkgconfig
