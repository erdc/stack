extends: [setuptools_package]

dependencies:
  build: [setuptools, blas, cython]
  run: [blas, cython]

sources:
 - key: zip:sup67yx3op4eyyql5rhaahuavag5viny
   url: https://files.pythonhosted.org/packages/da/32/1b8f2bb5fb50e4db68543eb85ce37b9fa6660cd05b58bddfafafa7ed62da/numpy-1.17.0.zip

build_stages:
  - name: create-site.cfg
    before: install
    handler: bash
    bash: |
      cat > site.cfg << EOF
      [ALL]
      extra_link_args = -shared
      [openblas]
      libraries = openblas
      library_dirs = ${OPENBLAS_DIR}/lib
      include_dirs = ${OPENBLAS_DIR}/include
      runtime_library_dirs = ${OPENBLAS_DIR}/include
      EOF

  - name: set-LDFLAGS
    before: install
    handler: bash
    bash: |
      export NPY_DISTUTILS_APPEND_FLAGS=1
      export LDFLAGS="-shared -Wl,-rpath=${PYTHON_DIR}/lib -Wl,-rpath=${OPENBLAS_DIR}/lib $(${PYTHON_DIR}/bin/python-config --ldflags)"
      #export ATLAS=None
      export LAPACK=None
      export BLAS=None

  - when: machine == 'SGIICEX'
    name: create-site.cfg
    before: install
    files:
      - 'version_match.patch'
    handler: bash
    bash: |
      patch -p0 < _hashdist/version_match.patch
      cat > site.cfg << EOF
      [ALL]
      extra_link_args = -shared
      [openblas]
      libraries = openblas
      library_dirs = ${OPENBLAS_DIR}/lib
      include_dirs = ${OPENBLAS_DIR}/include
      runtime_library_dirs = ${OPENBLAS_DIR}/include
      EOF

  - when: machine == 'SGIICEX'
    name: set-LDFLAGS
    after: prologue
    before: install
    handler: bash
    bash: |
      export LDFLAGS="-shared -Wl,-rpath=${PYTHON_DIR}/lib -Wl,-rpath=${OPENBLAS_DIR}/lib $(${PYTHON_DIR}/bin/python-config --ldflags)"
      export LAPACK=None
      export BLAS=None
      export ATLAS=None

  - when: platform == 'Cygwin'
    name: set-LDFLAGS
    before: install
    handler: bash
    bash: |
      export LDFLAGS="-shared -Wl,-rpath=${PYTHON_DIR}/lib -Wl,-rpath=/usr/lib $(${PYTHON_DIR}/bin/python-config --ldflags)"
      #export ATLAS=None
      export LAPACK=None
      export BLAS=None
